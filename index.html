<!DOCTYPE html>
<!-- saved from url=(0043)http://localhost:3999/actionmodules.slide#1 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Advanced Ansible</title>
    
    <script>
      var notesEnabled =  false ;
    </script>
    <script src="./index_files/slides.js"></script>

    

    <script>
      
      if (window["location"] && window["location"]["hostname"] == "talks.golang.org") {
        var _gaq = _gaq || [];
        _gaq.push(["_setAccount", "UA-11222381-6"]);
        _gaq.push(["b._setAccount", "UA-49880327-6"]);
        window.trackPageview = function() {
          _gaq.push(["_trackPageview", location.pathname+location.hash]);
          _gaq.push(["b._trackPageview", location.pathname+location.hash]);
        };
        window.trackPageview();
        window.trackEvent = function(category, action, opt_label, opt_value, opt_noninteraction) {
          _gaq.push(["_trackEvent", category, action, opt_label, opt_value, opt_noninteraction]);
          _gaq.push(["b._trackEvent", category, action, opt_label, opt_value, opt_noninteraction]);
        };
      }
    </script>
  <meta name="viewport" content="width=1100,height=750"><meta name="apple-mobile-web-app-capable" content="yes"></head>

  <body style="display: none" class="loaded">

    <section class="slides layout-widescreen">
      
      <article class="current">
        <h1>Advanced Ansible</h1>
        <h3>Action Modules for Fun And Profit</h3>
        
        
          <div class="presenter">
            
  
  <p>
    Henry Finucane
  </p>
  

          </div>
        
      </article>
      
  
  
      <article class="next">
      
        <h3></h3>
        
<div class="image">
  <img src="./index_files/ansible_badge.png">
</div>

  <ul>
  
    <li>Chef, Puppet, Salt, competitor</li>
  
    <li>Describe state</li>
  
    <li>Core in Python, you work in YAML</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="far-next">
      
        <h3>YAML</h3>
        
  
  <p>
    Great at lists
  </p>
  

  
  <div class="code"><pre>- apt: pkg=nginx

- file: path=/var/run/lockfile state=absent</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <p>
    Great at lists
  </p>
  

  
  <div class="code"><pre>- apt: pkg=nginx

- file: path=/var/run/lockfile state=absent</pre></div>
  

  
  <p>
    JSON for scale:
  </p>
  

  
  <div class="code"><pre>[ { "apt": "pkg=nginx" }, { "file": "/var/run/lockfile state=absent" } ]</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <p>
    Great at <b>data</b>
  </p>
  

  
  <div class="code"><pre>nginx:
  port: 443
  ssl:
    enable: True
    certificate: /etc/nginx/ssl/hostname.cert</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Python</h3>
        
  
  <div class="code"><pre>if os.path.exists('/run/mysql.pid'):
    subprocess.call(['mysqladmin', 'shutdown'])</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <div class="code"><pre>- stat: path=/run/mysql.pid
  register: mysql_pid

- command: mysqladmin shutdown
  when: mysql_pid|exists</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Python &amp; YAML</h3>
        
  
  <div class="code"><pre>if os.path.exists('/run/mysql.pid'):
    subprocess.call(['mysqladmin', 'shutdown'])</pre></div>
  

  
  <p>
    vs
  </p>
  

  
  <div class="code"><pre>- stat: path=/run/mysql.pid
  register: mysql_pid

- command: mysqladmin shutdown
  when: mysql_pid|exists</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <p>
    Logic becomes awkward fast
  </p>
  

  <ul>
  
    <li><code>register:</code> everything</li>
  
    <li>No visual grouping</li>
  
    <li>Integration-testing only</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <p>
    Logic is actually pretty inefficient
  </p>
  

  
  <div class="code"><pre>- foo: a=x b=y
  register: foo_result

- bar: dest=z
  when: foo_result|changed</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <div class="code"><pre>- foo: a=x b=y
  register: foo_result

- bar: dest=z
  when: foo_result|changed</pre></div>
  

  <ul>
  
    <li>Ship foo to the remote host</li>
  
    <li>Execute foo</li>
  
    <li>Ship results back, parse, evaluate when</li>
  
    <li>Conditionally ship bar</li>
  
    <li>Conditionally execute bar</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <p>
    Including a long task many times will scale poorly
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <p>
    Including a long task many times will scale poorly
  </p>
  

  
  <p>
    Ansible is pretty fast
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <p>
    Including a long task many times will scale poorly
  </p>
  

  
  <p>
    Ansible is pretty fast
  </p>
  

  
  <p>
    This is a terrible reason to make decisions
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>YAML</h3>
        
  
  <p>
    Including a long task many times will scale poorly
  </p>
  

  
  <p>
    Ansible is pretty fast
  </p>
  

  
  <p>
    This is a terrible reason to make decisions
  </p>
  

  
  <p>
    Sometimes it has to happen
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h2>Modules</h2>
      
      </article>
  
  
  
      <article>
      
        <h2>Modules Are Great</h2>
      
      </article>
  
  
  
      <article>
      
        <h3>Really easy to write</h3>
        
  <ul>
  
    <li>A script that returns json</li>
  
    <li>Ansible has a bunch of helper libraries</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>Modules can't do everything</h3>
        
  
  <p>
    They run on the host you are deploying to
  </p>
  

  
  <p>
    You can work around this:
  </p>
  

  
  <div class="code"><pre>- fetch: http://internal_repo/bar.deb
  local_action: True</pre></div>
  

  
  <p>
    But if you're going to do this a lot...
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Modules can't run on the host and the remote</h3>
        
  
  <p>
    There's always
  </p>
  

  
  <div class="code"><pre>- complicated_fetch: http://wubwubwub/dubstep
  register: cf

- synchronize: src={{cf|dest}} dest=/var/tmp/cf

- setup: src=/var/tmp/cf</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h2>Warning: Theorizing ahead</h2>
      
      </article>
  
  
  
      <article>
      
        <h3>API Matters</h3>
        
  <ul>
  
    <li>DevOps is not just making sure that someone can push 'play'</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>API Matters</h3>
        
  <ul>
  
    <li>DevOps is not just making sure that someone can push 'play'</li>
  
    <li>LL has a lot of small teams that do slightly different deployments- the nature of our work</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>API Matters</h3>
        
  <ul>
  
    <li>DevOps is not just making sure that someone can push 'play'</li>
  
    <li>LL has a lot of small teams that do slightly different deployments- the nature of our work</li>
  
    <li>Tooling for Ansible should be legible &amp; native seeming</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>API Matters</h3>
        
  
  <p>
    If you have a bad API, eventually, your work will get re-implemented
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>API Matters</h3>
        
  
  <p>
    If you have a bad API, eventually, your work will get re-implemented
  </p>
  

  
  <p>
    It's really easy to do simple deployment things wrong
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>API Matters</h3>
        
  
  <p>
    If you have a bad API, eventually, your work will get re-implemented
  </p>
  

  
  <p>
    It's really easy to do simple deployment things wrong
  </p>
  

  
  <p>
    The kind of wrong that works just fine in most circumstances
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3></h3>
        
<div class="image">
  <img src="./index_files/segway.jpg">
</div>

      
      </article>
  
  
  
      <article>
      
        <h3>Action Plugins Are Amazing</h3>
        
  
  <p>
    Action Plugins can do anything
  </p>
  

  <ul>
  
    <li>Coalesce multiple modules into a single piece of API</li>
  
    <li>Modify transport parameters</li>
  
    <li>Change transports</li>
  
    <li>Turn off check mode, and run modules[1]</li>
  
    <li>Monkeypatch Ansible[2]</li>
  
  </ul>

  
  <p>
    [1]: Presumably, because you are a monster
<br>

    [2]: Honestly this is probably a bad idea
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Template</h3>
        
  
  <p>
    Have you ever wondered how it works?
  </p>
  

  <ul>
  
    <li>Render on your machine ( no need to install Jinja2 on the remote )</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>Template</h3>
        
  
  <p>
    Have you ever wondered how it works?
  </p>
  

  <ul>
  
    <li>Render on your machine ( no need to install Jinja2 on the remote )</li>
  
    <li>Figures out if it needs to do anything, maybe spits out a diff</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>Template</h3>
        
  
  <p>
    Have you ever wondered how it works?
  </p>
  

  <ul>
  
    <li>Render on your machine ( no need to install Jinja2 on the remote )</li>
  
    <li>Figures out if it needs to do anything, maybe spits out a diff</li>
  
    <li>Copies the template to a temporary directory on the remote</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>Template</h3>
        
  
  <p>
    Have you ever wondered how it works?
  </p>
  

  <ul>
  
    <li>Render on your machine ( no need to install Jinja2 on the remote )</li>
  
    <li>Figures out if it needs to do anything, maybe spits out a diff</li>
  
    <li>Copies the template to a temporary directory on the remote</li>
  
    <li>Asks the <code>copy</code> module to finish the task</li>
  
  </ul>

      
      </article>
  
  
  
      <article>
      
        <h3>Template</h3>
        
  
  <p>
    Have you ever wondered how it works?
  </p>
  

  
  <div class="code"><pre># template the source data locally &amp; get ready to transfer
resultant = self._templar.template(template_data, preserve_trailing_newlines=True, escape_backslashes=False, convert_data=False)
...
result.update(self._execute_module(module_name='copy', module_args=new_module_args, task_vars=task_vars, tmp=tmp, delete_remote_tmp=False))
...
if result.get('changed', False) and self._play_context.diff:
    result['diff'] = diff
return result</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Hello World</h3>
        
  
  <p>
    in action_plugins/hello.py:
  </p>
  

  
  <div class="code"><pre>from ansible.runner.return_data import ReturnData

class ActionModule(object):
    def __init__(self, runner):
        self.runner = runner

    def run(self, conn, tmp, module_name, module_args, inject, complex_args=None, **kwargs):
        return ReturnData(conn=conn,
                          comm_ok=True,
                          result=dict(failed=False, changed=False, msg="Hello World"))</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Hello World</h3>
        
  
  <p>
    in action_plugins/hello.py:
  </p>
  

  
  <div class="code"><pre>from ansible.plugins.action import ActionBase

class ActionModule(ActionBase):
    def run(self, tmp=None, task_vars=None):
        return dict(msg="Hello World", _ansible_verbose_always=True)</pre></div>
  

  
  <p>
    a file called library/hello
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Hello World</h3>
        
  
  <div class="code"><pre>$ ansible all -i localhost, -m hello

localhost | success &gt;&gt; {
    "changed": false, 
    "failed": false, 
    "msg": "Hello World"
}</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>action_plugins &amp; library?</h3>
        
  
  <p>
    An action plugin must have a module with the same name
  </p>
  

  
  <p>
    You can divide the work into action plugin/module concerns
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>action_plugins &amp; library?</h3>
        
  
  <p>
    An action plugin must have a module with the same name
  </p>
  

  
  <p>
    You can also divide the work into action plugin/module concerns
  </p>
  

  
  <p>
    <code>copy</code> does this.
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Tying Action Plugins Together</h3>
        
  
  <div class="code"><pre>from ansible.plugins.action.synchronize import ActionModule as Sync</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Tying Action Plugins Together</h3>
        
  
  <div class="code"><pre>from ansible.plugins.action.synchronize import ActionModule as Sync</pre></div>
  

  
  <p>
    Usage requires some boilerplate:
  </p>
  

  
  <div class="code"><pre>sync = Sync(self._task,
            self._connection,
            self._play_context,
            self._loader,
            self._templar,
            self._shared_loader_obj)
sync_result = sync.run(tmp=tmp, task_vars=task_vars)</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Accessing global variables</h3>
        
  
  <p>
    I don't have a non-hacky method for this in Ansible 2, but the following will work:
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Accessing global variables</h3>
        
  
  <div class="code"><pre>all_variables = self._templar.template('{{vars}}')</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Accessing global variables</h3>
        
  
  <div class="code"><pre>all_variables = self._templar.template('{{vars}}')</pre></div>
  

  
  <p>
    This abuses Ansible's support for `debug: var=vars`, so it's likely to keep
<br>

    working, but asking the templating system to give you the current context, and
<br>

    assuming it will come out as a structure instead of a string is a definitely
<br>

    straddling a line.
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Logging</h3>
        
  
  <p>
    First step, get access to the current logging object, called "display"
  </p>
  

  
  <div class="code"><pre>try:
    from __main__ import display
except ImportError:
    from ansible.utils.display import Display
    display = Display()</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Logging</h3>
        
  
  <div class="code"><pre>display.vv('log a message')
display.vvv('log something maybe a bit less important')</pre></div>
  

  
  <p>
    Corresponds to <code>-vv</code> or <code>-vvv</code> on the command line.
  </p>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Logging</h3>
        
  
  <p>
    You can support arbitrarily large numbers of Vs
  </p>
  

  
  <div class="code"><pre>display.verbose("Super custom verbosity", caplevel=42)</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Diff mode</h3>
        
  
  <p>
    Ansible 2.0 supports diff mode in regular modules:
  </p>
  

  
  <div class="code"><pre>#!/usr/bin/python

print r'{"failed": false, "changed": true, "diff": {"before": "fee\nfo\nfum\n", "after": "fee\nfi\nfum\n"}}'</pre></div>
  

  
  <p>
    gives you
  </p>
  

  
  <div class="code"><pre>changed: [localhost]
--- before
+++ after
@@ -1,3 +1,3 @@
 fee
-fo
+fi
 fum</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Diff mode</h3>
        
  
  <p>
    Everything is done above the level of an individual action module, so you don't
<br>

    have to do anything special here either:
  </p>
  

  
  <div class="code"><pre>class ActionModule(ActionBase):
    def run(self, tmp=None, task_vars=None):
        # If there's no change, Ansible assumes there can be no diff
        return {'changed': True, 'diff': { 'before': 'foo\nbar', 'after': 'bar' } }</pre></div>
  

  
  <p>
    Gives you
  </p>
  

  
  <div class="code"><pre>--- before
+++ after
@@ -1,2 +1 @@
-foo
 bar
ok: [localhost]</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Connection Magic</h3>
        
  
  <p>
    The synchronize action module will actually change your transport in flight:
  </p>
  

  
  <div class="code"><pre>if not use_delegate and remote_transport:
    new_stdin = self._connection._new_stdin
    ...
    new_connection = connection_loader.get('local', self._play_context, new_stdin)
    self._connection = new_connection

... 
self._execute_module('synchronize', task_vars=task_vars)</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Connection Magic</h3>
        
  
  <p>
    Wait, what?
  </p>
  

  
  <div class="code"><pre>$ ansible all -i localhost, -m file -a "path=/var/tmp/x state=present"
localhost | FAILED =&gt; SSH encountered an unknown error during the connection. We recommend you re-run the command using -vvvv, which will enable SSH debugging output to help diagnose the issue
$ ssh localhost
ssh: connect to host localhost port 22: Connection refused
$ ansible all -i localhost, -c local -m file -a "path=/var/tmp/x state=present"</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Connection Magic for SSH</h3>
        
  
  <p>
    Super-duper-bulletproof iptables application
  </p>
  

  
  <div class="code"><pre>- apply: src=/etc/iptables/iptables.v4
- apply_confirm:</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Connection Magic for SSH</h3>
        
  
  <p>
    <code>ControlPersist</code>
  </p>
  

  
  <p>
    Ansible's speed secret sauce
  </p>
  

  
  <p>
    Turning it off is, broadly, not a great idea
  </p>
  

  
  <p>
    In ansible.cfg:
  </p>
  

  
  <div class="code"><pre>ssh_args = -o ControlMaster=auto -o ControlPersist=60s</pre></div>
  

      
      </article>
  
  
  
      <article>
      
        <h3>Connection Magic for SSH</h3>
        
  
  <p>
    Run ping, but with no ControlPersist:
  </p>
  

  
  <div class="code"><pre>class ActionModule(ActionBase):
    def run(self, tmp=None, task_vars=None):
        self._play_context.ssh_args = ''
        result = self._execute_module('ping', task_vars=task_vars)
        return result</pre></div>
  

      
      </article>
  
  

      <article>
        <h3>Thank you</h3>
        
          <div class="presenter">
            
  
  <p>
    Henry Finucane
  </p>
  

          </div>
        
      </article>

    <div class="slide-area" id="prev-slide-area"></div><div class="slide-area" id="next-slide-area"></div></section>

    <div id="help" style="display: none;">
      Use the left and right arrow keys or click the left and right
      edges of the page to navigate between slides.<br>
      (Press 'H' or navigate to hide this message.)
    </div>

    
    <script src="./index_files/play.js"></script>
    

    <script>
      (function() {
        
        if (window["location"] && window["location"]["hostname"] == "talks.golang.org") {
          var ga = document.createElement("script"); ga.type = "text/javascript"; ga.async = true;
          ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";
          var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ga, s);
        }
      })();
    </script>
  

<link rel="stylesheet" type="text/css" href="./index_files/css"><link rel="stylesheet" type="text/css" href="./index_files/styles.css"></body></html>